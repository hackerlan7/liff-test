<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIFF 取號</title>
<style>
  :root{
    --bg:#0b0b12; --text:#e5e7eb; --muted:#9ca3af;
    --brand:#6D28D9; --brand-2:#8B5CF6; --ok:#10b981; --err:#ef4444; --accent:#C4B5FD;
  }
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 700px at 20% -10%, rgba(109,40,217,.25), transparent),
               radial-gradient(1200px 700px at 120% 110%, rgba(139,92,246,.2), transparent),
               var(--bg);
    color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Heiti TC",system-ui,sans-serif;
    display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .wrap{width:min(680px,92vw)}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    border-radius:16px; padding:20px 18px; backdrop-filter: blur(6px);
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  pre{white-space:pre-wrap; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; color:#cbd5e1}
  .btn{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer}
  .btn-primary{background:linear-gradient(90deg, var(--brand), var(--brand-2)); color:white}
  .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.15); color:var(--text)}
  .center{display:flex; align-items:center; justify-content:center}
  .ticket{width:min(280px,70vw); height:150px; border-radius:16px; position:relative;
    background:linear-gradient(90deg, var(--brand), var(--brand-2));
    box-shadow:0 10px 25px rgba(0,0,0,.35); animation:bounce 1.1s ease-in-out infinite;
  }
  .ticket:before,.ticket:after{
    content:""; position:absolute; width:24px; height:24px; background:var(--bg); border-radius:50%;
    top:50%; transform:translateY(-50%);
  }
  .ticket:before{left:-12px} .ticket:after{right:-12px}
  .num{position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:64px; letter-spacing:1px; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.3);
    filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); transition:transform .2s ease,opacity .2s ease;
  }
  .subtitle{ position:absolute; bottom:8px; width:100%; text-align:center; font-size:13px; color:#f0f0f0; opacity:.9 }
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .pop{animation:pop .5s ease-out forwards}@keyframes pop{0%{transform:scale(0.9)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .glow{box-shadow:0 0 0 0 rgba(197,181,253,.75); animation:glow .9s ease-out 2}@keyframes glow{0%{box-shadow:0 0 0 0 rgba(197,181,253,.75)}100%{box-shadow:0 0 30px 12px rgba(197,181,253,0)}}
  canvas#confetti{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:5}
  .grid{display:grid; gap:14px; grid-template-columns:1fr 1fr}
  .badge{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12)}
  .count{font-weight:800; font-size:28px; letter-spacing:.5px}
</style>

<script>
  const LIFF_ID  = '2008311996-D2KEdEnm';
  const GAS_EXEC = 'https://script.google.com/macros/s/AKfycbzQhqzkAq0V4DqTgh7cSVt-lT1_N0AhRkwutfhZK8yeXPaB2mbG7r6X4g3VQNIzY9r4/exec';
  const DEFAULT_MODE = 'dev';
</script>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:6px">
      <div><b>LIFF 取號</b> <span class="badge" id="modeBadge">mode: dev</span></div>
      <div class="muted" id="stepHint">初始化 LIFF…</div>
    </div>

    <div class="center" style="margin:12px 0 8px; position:relative">
      <div class="ticket" id="ticket">
        <div class="num" id="num">—</div>
        <div class="subtitle" id="sub">正在抽取您的號碼…</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div><div class="muted">狀態</div><div id="status" class="ok">啟動中</div></div>
      <div style="text-align:right"><div class="muted">關閉倒數</div><div id="countdown" class="count">—</div></div>
    </div>

    <div id="logWrap" style="margin-top:12px; display:none">
      <div class="muted" style="margin-bottom:6px">開發日誌</div>
      <pre id="log"></pre>
    </div>

    <div class="row" style="margin-top:10px; justify-content:flex-end; gap:10px">
      <button class="btn btn-ghost" id="closeNow" style="display:none">立即關閉</button>
      <button class="btn btn-primary" id="openChat" style="display:none">回到聊天室</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  const qs = new URL(location.href).searchParams;
  const action = (qs.get('action') || 'default').toLowerCase();
  const mode = (qs.get('mode') || DEFAULT_MODE).toLowerCase();
  const isDev = mode === 'dev';
  const $ = id => document.getElementById(id);
  $('modeBadge').textContent = `mode: ${mode}`;
  const log = (...a)=>{ if(isDev){ $('logWrap').style.display='block'; $('log').textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ')+'\n'; } };
  const setStatus=(t,cls='')=>{const el=$('status'); el.textContent=t; el.className=cls||'';}
  const setHint=t=>$('sub').textContent=t;

  function startRolling(){
    const el=$('num'); let rolling=true; (function loop(){
      if(!rolling)return; el.textContent='#'+String(Math.floor(Math.random()*999)).padStart(3,'0');
      setTimeout(loop,40);
    })(); return ()=>rolling=false;
  }

  function stopRolling(finalText){
    const el=$('num'),t=$('ticket'); el.textContent=finalText; t.classList.add('pop','glow');
  }

  async function sendToGas(payload){
    try{
      const res=await fetch(GAS_EXEC,{
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify(payload),
        redirect:'follow',
        cache:'no-store',
        mode:'cors'
      });
      if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
      const data=await res.json().catch(()=>null);
      log('POST json',data);
      return {channel:'ok:fetch',data};
    }catch(e){
      log('POST failed → beacon',e?.message||e);
      const u=new URL(GAS_EXEC);
      u.searchParams.set('userId',payload.userId);
      u.searchParams.set('name',payload.displayName||'');
      u.searchParams.set('action',payload.action);
      u.searchParams.set('source',payload.source||'liff');
      u.searchParams.set('cb',Date.now());
      (new Image()).src=u.toString();
      return {channel:'ok:beacon',data:null};
    }
  }

  try{
    $('stepHint').textContent='初始化 LIFF…';
    await liff.init({liffId:LIFF_ID,withLoginOnExternalBrowser:true});
    if(!liff.isLoggedIn()) return liff.login();
    setStatus('已登入','ok');

    const prof=await liff.getProfile();
    log('profile',prof);
    const stop=startRolling();
    const {data}=await sendToGas({userId:prof.userId,displayName:prof.displayName,action,source:'liff'});
    stop();
    if(data&&data.result&&data.result.ticket){
      stopRolling('#'+data.result.ticket);
      setHint('取號成功！');
      setStatus('請回聊天室查看','ok');
    }else{
      stopRolling('—');
      setHint('請稍後查看聊天室');
      setStatus('發送完成','ok');
    }
  }catch(e){
    setStatus('發生錯誤：'+(e?.message||e),'err');
    setHint('請返回上一頁或稍後再試');
  }
})();
</script>
