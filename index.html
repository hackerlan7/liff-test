<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LIFF å–è™Ÿ</title>
<style>
  :root{
    --bg:#0b0b12; --text:#e5e7eb; --muted:#9ca3af;
    --brand:#6D28D9; --brand-2:#8B5CF6; --ok:#10b981; --err:#ef4444; --accent:#C4B5FD;
  }
  html,body{height:100%;}
  body{
    margin:0; background: radial-gradient(1200px 700px at 20% -10%, rgba(109,40,217,.25), transparent),
               radial-gradient(1200px 700px at 120% 110%, rgba(139,92,246,.2), transparent),
               var(--bg);
    color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Heiti TC",system-ui,sans-serif;
    display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .wrap{width:min(680px,92vw);}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    border-radius:16px; padding:20px 18px; backdrop-filter: blur(6px);
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  pre{white-space:pre-wrap; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; color:#cbd5e1}
  .btn{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer}
  .btn-primary{background:linear-gradient(90deg, var(--brand), var(--brand-2)); color:white}
  .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,.15); color:var(--text)}
  .center{display:flex; align-items:center; justify-content:center}
  .ticket{ width:min(280px,70vw); height:150px; border-radius:16px; position:relative;
    background:
      linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 40%) no-repeat,
      linear-gradient(90deg, var(--brand), var(--brand-2));
    box-shadow:0 10px 25px rgba(0,0,0,.35);
    animation:bounce 1.1s ease-in-out infinite;
  }
  .ticket:before,.ticket:after{ content:""; position:absolute; width:24px; height:24px; background:var(--bg); border-radius:50%;
    top:50%; transform:translateY(-50%); }
  .ticket:before{left:-12px} .ticket:after{right:-12px}
  .num{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:64px; letter-spacing:1px; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.3);
    filter: drop-shadow(0 6px 18px rgba(0,0,0,.35)); transition: transform .2s ease, opacity .2s ease; }
  .subtitle{ position:absolute; bottom:8px; width:100%; text-align:center; font-size:13px; color:#f0f0f0; opacity:.9; }
  .shine{ position:absolute; inset:0; overflow:hidden; border-radius:16px; mix-blend-mode:screen; pointer-events:none; }
  .shine:before{ content:""; position:absolute; top:-60%; left:-20%; width:40%; height:220%;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.55) 45%, rgba(255,255,255,0) 80%);
    transform:rotate(20deg); animation:shine 1.6s linear infinite; }
  @keyframes shine{0%{transform:translateX(-120%) rotate(20deg)}100%{transform:translateX(320%) rotate(20deg)}}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .pop{animation:pop .5s ease-out forwards}
  @keyframes pop{0%{transform:scale(0.9)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .glow{box-shadow:0 0 0 0 rgba(197,181,253,.75); animation:glow .9s ease-out 2}
  @keyframes glow{0%{box-shadow:0 0 0 0 rgba(197,181,253,.75)}100%{box-shadow:0 0 30px 12px rgba(197,181,253,0)}}
  canvas#confetti{position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:5}
  .grid{display:grid; gap:14px; grid-template-columns:1fr 1fr}
  .badge{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12)}
  .count{font-weight:800; font-size:28px; letter-spacing:.5px}
</style>

<!-- æ›æˆä½ çš„å€¼ -->
<script>
  const LIFF_ID  = '2008311996-D2KEdEnm';
  const GAS_EXEC = 'https://script.google.com/macros/s/AKfycbzQhqzkAq0V4DqTgh7cSVt-lT1_N0AhRkwutfhZK8yeXPaB2mbG7r6X4g3VQNIzY9r4/exec';
  const DEFAULT_MODE = 'prod'; // ç”¨ ?mode=dev åˆ‡ dev

  // æ•¸å­—è¼ªæ’­è¨­å®š
  const ROLL_MIN_MS = 800;
  const ROLL_SPEED_MS = 45;   // æœ€çµ‚é€Ÿåº¦
  const ROLL_DIGITS = 3;      // ä½æ•¸ï¼ˆ3â†’001-999ï¼‰
</script>

<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:6px">
      <div><b>LIFF å–è™Ÿ</b> <span class="badge" id="modeBadge">mode: prod</span></div>
      <div class="muted" id="stepHint">åˆå§‹åŒ– LIFFâ€¦</div>
    </div>

    <div class="center" style="margin:12px 0 8px; position:relative">
      <div class="ticket" id="ticket">
        <div class="shine"></div>
        <div class="num" id="num">â€¦</div>
        <div class="subtitle" id="sub">æ­£åœ¨æŠ½å–æ‚¨çš„è™Ÿç¢¼â€¦</div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div><div class="muted">ç‹€æ…‹</div><div id="status" class="ok">å•Ÿå‹•ä¸­</div></div>
      <div style="text-align:right"><div class="muted">é—œé–‰å€’æ•¸</div><div id="countdown" class="count">â€”</div></div>
    </div>

    <div id="logWrap" style="margin-top:12px; display:none">
      <div class="muted" style="margin-bottom:6px">é–‹ç™¼æ—¥èªŒ</div>
      <pre id="log"></pre>
    </div>

    <div class="row" style="margin-top:10px; justify-content:flex-end; gap:10px">
      <button class="btn btn-ghost" id="closeNow" style="display:none">ç«‹å³é—œé–‰</button>
      <button class="btn btn-primary" id="openChat" style="display:none">å›åˆ°èŠå¤©å®¤</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  const qs = new URL(location.href).searchParams;
  const action = (qs.get('action') || 'default').toLowerCase(); // default | view | renew
  const mode = (qs.get('mode') || DEFAULT_MODE).toLowerCase();
  const isDev = mode === 'dev';
  const $ = (id)=>document.getElementById(id);
  document.getElementById('modeBadge').textContent = `mode: ${mode}`;

  const log = (...a)=>{ if(isDev){ $('logWrap').style.display='block'; $('log').textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ')+'\n'; } };
  const setStatus = (t, cls='')=>{ const el=$('status'); el.textContent=t; el.className=cls||''; };
  const setHint = (t)=>{ $('sub').textContent = t; };

  // æ•¸å­—è¼ªæ’­ï¼ˆæ¸›é€Ÿï¼‰
  let rolling=false;
  function startRolling(){
    if (rolling) return; rolling = true;
    const el = $('num');
    let speed = 18, accel = 1.06; // èµ·å¿«â†’æ¼¸æ…¢
    function step(){
      if (!rolling) return;
      el.textContent = '#' + String(Math.floor(Math.random()*1000)).padStart(ROLL_DIGITS,'0');
      speed = Math.min(speed * accel, ROLL_SPEED_MS);
      setTimeout(()=> requestAnimationFrame(step), speed);
    }
    requestAnimationFrame(step);
  }
  function stopRolling(finalText){
    if (!rolling) return;
    rolling=false;
    const el=$('num'); const t=$('ticket');
    el.style.opacity='0';
    setTimeout(()=>{
      el.textContent = finalText;
      el.style.opacity='1';
      t.classList.remove('pop','glow'); void t.offsetWidth; t.classList.add('pop','glow');
      confettiBurst();
    }, 120);
  }

  // confetti
  function confettiBurst(){
    const canvas = $('confetti'), ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    function resize(){ canvas.width=innerWidth*dpr; canvas.height=innerHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
    resize(); window.addEventListener('resize', resize, {once:true});
    const colors = ['#8B5CF6','#6D28D9','#C4B5FD','#ffffff'];
    const pieces = Array.from({length: 120}).map(()=>({
      x: Math.random()*innerWidth, y: -20 - Math.random()*40,
      r: 2 + Math.random()*4, c: colors[(Math.random()*colors.length)|0],
      vy: 2 + Math.random()*3, vx: -1 + Math.random()*2, a: Math.random()*Math.PI
    }));
    let t = 0; (function draw(){
      ctx.clearRect(0,0,innerWidth,innerHeight);
      pieces.forEach(p=>{ p.a+=.1; p.x+=p.vx; p.y+=p.vy;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
        ctx.fillStyle=p.c; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
      });
      t++; if (t<90) requestAnimationFrame(draw); else ctx.clearRect(0,0,innerWidth,innerHeight);
    })();
  }

  // è‡ªå‹•é—œé–‰
  function autoClose(seconds){
    const el=$('countdown'); let n=seconds;
    const timer=setInterval(async ()=>{
      el.textContent = n + 's'; n--;
      if(n<0){
        clearInterval(timer);
        try{
          if (liff.isInClient()) liff.closeWindow();
          else {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) { location.href = 'https://liff.line.me/' + LIFF_ID; setTimeout(()=>location.replace('about:blank'), 2000); }
            else { location.replace('about:blank'); }
          }
        }catch(_){ location.replace('about:blank'); }
      }
    },1000);
  }

  // é€ GASï¼ˆPOST æ‹¿ JSONï¼›å¤±æ•—â†’Beaconï¼‰
  async function sendToGas(payload){
    try{
      const res = await fetch(GAS_EXEC, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>null);
      log('POST json', data);
      return { channel:'ok:fetch', data };
    }catch(e){
      log('POST failed â†’ beacon', e?.message||e);
      const u = new URL(GAS_EXEC);
      u.searchParams.set('userId', payload.userId);
      u.searchParams.set('name', payload.displayName || ''); // Beacon ç”¨ name åƒæ•¸
      u.searchParams.set('action', payload.action);
      u.searchParams.set('source', payload.source || 'liff');
      u.searchParams.set('cb', Date.now());
      (new Image()).src = u.toString();
      return { channel:'ok:beacon', data:null };
    }
  }

  // æ§åˆ¶æŒ‰éˆ•
  $('closeNow').onclick = ()=>{ try{ if (liff.isInClient()) liff.closeWindow(); else window.close(); }catch(_){} };
  $('openChat').onclick = ()=>{ try{ liff.closeWindow(); }catch(_){} };

  try{
    $('stepHint').textContent = 'åˆå§‹åŒ– LIFFâ€¦';
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    setStatus('å·²åˆå§‹åŒ– âœ…','ok');

    if(!liff.isLoggedIn()){ setStatus('æœªç™»å…¥ï¼Œå°å‘ç™»å…¥â€¦','muted'); return liff.login(); }

    $('stepHint').textContent = 'å–å¾—ä½¿ç”¨è€…â€¦';
    const prof = await liff.getProfile(); // â† é€™è£¡æ‹¿åˆ° displayName / userId
    log('profile', prof);

    // æ–‡æ¡ˆï¼‹è¼ªæ’­
    if (action === 'renew') setHint('æ­£åœ¨é‡æ–°é ˜å–æ–°è™Ÿç¢¼â€¦');
    else if (action === 'view') setHint('æŸ¥è©¢æ‚¨çš„è™Ÿç¢¼ç‰Œâ€¦');
    else setHint('æ­£åœ¨æŠ½å–æ‚¨çš„è™Ÿç¢¼â€¦');
    startRolling();

    // é€å‡º
    setStatus('é€å‡ºä¸­â€¦','muted');
    const t0 = performance.now();
    const { channel, data } = await sendToGas({ userId: prof.userId, displayName: prof.displayName, action, source:'liff' });
    const elapsed = performance.now() - t0;
    const waitMore = Math.max(0, ROLL_MIN_MS - elapsed);
    await new Promise(r => setTimeout(r, waitMore));

    // å¾ JSON æŠ“ç¥¨è™Ÿ
    let ticket = data && data.result && data.result.ticket ? data.result.ticket : null;

    // å¦‚æœæ²’æœ‰ï¼ˆå¤šåŠèµ° Beaconï¼‰ï¼Œè£œæ‰“ä¸€ç™¼ view ä¾†æŸ¥ç¥¨
    if (!ticket) {
      setHint('æ­£åœ¨ç¢ºèªæ‚¨çš„è™Ÿç¢¼â€¦');
      try {
        const again = await fetch(GAS_EXEC, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ userId: prof.userId, displayName: prof.displayName, action: 'view', source:'liff' })
        });
        const againData = await again.json().catch(()=>null);
        ticket = againData && againData.result && againData.result.ticket ? againData.result.ticket : null;
        log('view-again json', againData);
      } catch(_) {}
    }

    if (ticket){
      // é¡¯ç¤ºç¥¨è™Ÿ + ç‰¹æ•ˆ
      stopRolling('#' + ticket);
      $('openChat').style.display='inline-block';
      setStatus((action==='view'?'æŸ¥çœ‹å®Œæˆ':'ç™¼é€æˆåŠŸ') + 'ï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹ ğŸ“¨','ok');
      autoClose(action === 'view' ? 3 : 5);
    } else {
      // é‚„æ˜¯æ²’æœ‰ â†’ å„ªé›…æ”¶å°¾
      stopRolling('â€”');
      if (action === 'view') setHint('å·²é€å‡ºæŸ¥çœ‹è«‹æ±‚ï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹');
      else if (action === 'renew') setHint('é‡æ–°é ˜å–å·²é€å‡ºï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹');
      else setHint('å·²é€å‡ºå–è™Ÿï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹');
      $('openChat').style.display='inline-block';
      setStatus('å·²é€å‡ºè«‹æ±‚ ğŸ“¨','ok');
      autoClose(action === 'view' ? 3 : 5);
    }

  }catch(e){
    setStatus('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (e?.message || e), 'err');
    setHint('è«‹è¿”å›ä¸Šä¸€é æˆ–ç¨å¾Œå†è©¦');
    $('openChat').style.display='inline-block';
    try{ stopRolling('â€”'); }catch(_){}
  }
})();
</script>
