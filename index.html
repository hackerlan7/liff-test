<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIFF å–è™Ÿ</title>
<style>
  :root{--bg:#0b0b12;--text:#e5e7eb;--muted:#9ca3af;--brand:#6D28D9;--brand-2:#8B5CF6;--ok:#10b981;--err:#ef4444}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1200px 700px at 20% -10%, rgba(109,40,217,.25), transparent),
      radial-gradient(1200px 700px at 120% 110%, rgba(139,92,246,.2), transparent),
      var(--bg);
    color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Heiti TC",system-ui,sans-serif;
    display:flex;align-items:center;justify-content:center;padding:20px
  }
  .wrap{width:min(680px,92vw)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  pre{white-space:pre-wrap;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;color:#cbd5e1}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff}
  .center{display:flex;align-items:center;justify-content:center}
  .ticket{width:min(280px,70vw);height:150px;border-radius:16px;position:relative;background:linear-gradient(90deg,var(--brand),var(--brand-2));box-shadow:0 10px 25px rgba(0,0,0,.35)}
  .ticket:before,.ticket:after{content:"";position:absolute;width:24px;height:24px;background:var(--bg);border-radius:50%;top:50%;transform:translateY(-50%)}
  .ticket:before{left:-12px}.ticket:after{right:-12px}
  .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:64px;letter-spacing:1px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3)}
  .subtitle{position:absolute;bottom:8px;width:100%;text-align:center;font-size:13px;color:#f0f0f0;opacity:.9}
  .pop{animation:pop .5s ease-out forwards}
  @keyframes pop{0%{transform:scale(.9)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
</style>

<script>
  // â† æ›æˆä½ çš„
  const LIFF_ID  = '2008311996-D2KEdEnm';
  const GAS_EXEC = 'https://script.google.com/macros/s/AKfycbzQhqzkAq0V4DqTgh7cSVt-lT1_N0AhRkwutfhZK8yeXPaB2mbG7r6X4g3VQNIzY9r4/exec';

  const DEFAULT_MODE = 'dev';            // ç”¨ ?mode=dev å¯çœ‹æ—¥èªŒ
  const ROLL_INTERVAL = 45;               // äº‚æ•¸è™Ÿç¢¼æ›´æ–°é–“éš”(ms)
  const VIEW_RETRY_MAX = 5;               // GET æŸ¥ç¥¨ æœ€å¤§é‡è©¦æ¬¡æ•¸
  const VIEW_RETRY_DELAY = 600;           // æ¯æ¬¡é‡è©¦é–“éš”(ms)
</script>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div><b>LIFF å–è™Ÿ</b> <span class="muted" id="modeBadge">mode: dev</span></div>
      <div class="muted" id="step">åˆå§‹åŒ– LIFFâ€¦</div>
    </div>

    <div class="center" style="margin:12px 0 8px">
      <div class="ticket" id="ticket">
        <div class="num" id="num">â€”</div>
        <div class="subtitle" id="hint">æ­£åœ¨æŠ½å–æ‚¨çš„è™Ÿç¢¼â€¦</div>
      </div>
    </div>

    <div style="margin-top:12px"><div class="muted">ç‹€æ…‹</div><div id="status" class="ok">å•Ÿå‹•ä¸­</div></div>

    <div id="logBox" style="display:none;margin-top:12px">
      <div class="muted" style="margin-bottom:6px">é–‹ç™¼æ—¥èªŒ</div>
      <pre id="log"></pre>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn btn-primary" id="closeBtn" style="display:none">å›åˆ°èŠå¤©å®¤</button>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  const qs   = new URL(location.href).searchParams;
  const act  = (qs.get('action') || 'default').toLowerCase();  // default|view|renew
  const mode = (qs.get('mode') || DEFAULT_MODE).toLowerCase();
  const isDev = mode === 'dev';
  const $ = (id)=>document.getElementById(id);
  $('modeBadge').textContent = `mode: ${mode}`;
  const log = (...a)=>{ if(isDev){ $('logBox').style.display='block'; $('log').textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ')+'\n'; } };
  const setStatus=(t,cls)=>{ const el=$('status'); el.textContent=t; el.className=cls||''; };
  const setHint=t=>$('hint').textContent=t;

  // äº‚æ•¸è™Ÿç¢¼è¼ªæ’­
  let rollTimer=null;
  function startRoll(){ stopRoll(); rollTimer=setInterval(()=>{ $('num').textContent='#'+String(Math.floor(Math.random()*1000)).padStart(3,'0'); }, ROLL_INTERVAL); }
  function stopRoll(){ if(rollTimer){ clearInterval(rollTimer); rollTimer=null; } }
  function showTicket(n){ stopRoll(); $('num').textContent='#'+String(n).padStart(3,'0'); $('ticket').classList.add('pop'); }

  // POST åˆ° GASï¼›å¤±æ•—æ‰å› Beacon
  async function sendToGas(payload){
    try{
      const res = await fetch(GAS_EXEC, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify(payload),
        redirect:'follow', cache:'no-store', mode:'cors'
      });
      if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
      const data = await res.json().catch(()=>null);
      log('POST json', data);
      return data;
    }catch(e){
      log('POST failed â†’ beacon', e?.message || e);
      const u = new URL(GAS_EXEC);
      u.searchParams.set('userId', payload.userId);
      u.searchParams.set('name', payload.displayName || '');
      u.searchParams.set('action', payload.action);
      u.searchParams.set('source', payload.source || 'liff');
      u.searchParams.set('cb', Date.now());
      (new Image()).src = u.toString(); // å¯«è¡¨/æ¨æ’­
      return null; // äº¤çµ¦å¾ŒçºŒ GET è£œæŸ¥
    }
  }

  // GET format=json æŸ¥ç¥¨ï¼ˆé‡è©¦æ©Ÿåˆ¶ï¼‰
  async function queryTicket(userId, displayName){
    for(let i=0;i<VIEW_RETRY_MAX;i++){
      await new Promise(r=>setTimeout(r, VIEW_RETRY_DELAY));
      try{
        const u = new URL(GAS_EXEC);
        u.searchParams.set('format','json');
        u.searchParams.set('action','view');
        u.searchParams.set('userId', userId);
        u.searchParams.set('name', displayName || '');
        const r = await fetch(u.toString(), { method:'GET', cache:'no-store', mode:'cors' });
        const j = await r.json().catch(()=>null);
        log('GET view json', j);
        const t = j && j.result && j.result.ticket ? j.result.ticket : null;
        if (t) return t;
      }catch(_){ /* ignore and retry */ }
    }
    return null;
  }

  try{
    $('step').textContent = 'åˆå§‹åŒ– LIFFâ€¦';
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()) return liff.login();
    setStatus('å·²ç™»å…¥ âœ…','ok');

    const prof = await liff.getProfile();
    log('profile', prof);

    // æ–‡å­—æç¤º
    if (act==='view') setHint('æŸ¥è©¢æ‚¨çš„è™Ÿç¢¼ç‰Œâ€¦');
    else if (act==='renew') setHint('æ­£åœ¨é‡æ–°é ˜å–æ–°è™Ÿç¢¼â€¦');
    else setHint('æ­£åœ¨æŠ½å–æ‚¨çš„è™Ÿç¢¼â€¦');

    startRoll();

    // é€åˆ° GAS
    const data = await sendToGas({ userId: prof.userId, displayName: prof.displayName, action: act, source:'liff' });

    // å…ˆçœ‹ POST æ˜¯å¦ç›´æ¥å›ç¥¨
    let ticket = data && data.result && data.result.ticket ? data.result.ticket : null;

    // æ²’æœ‰ â†’ ç”¨ GET format=json è£œæŸ¥ï¼ˆBeacon æˆåŠŸæ™‚å¯æ’ˆåˆ°ï¼‰
    if (!ticket) ticket = await queryTicket(prof.userId, prof.displayName);

    if (ticket){
      showTicket(ticket);
      setStatus((act==='view'?'æŸ¥çœ‹å®Œæˆ':'ç™¼é€æˆåŠŸ')+'ï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹ ğŸ“¨','ok');
      $('closeBtn').style.display='inline-block';
    }else{
      stopRoll();
      $('num').textContent='â€”';
      setHint('å·²é€å‡ºè«‹æ±‚ï¼Œè«‹å›èŠå¤©å®¤æŸ¥çœ‹');
      setStatus('å·²é€å‡ºï¼ˆPOST å¤±æ•—â†’Beacon æˆåŠŸï¼‰','ok');
      $('closeBtn').style.display='inline-block';
    }

    $('closeBtn').onclick = ()=>{ try{ liff.closeWindow(); }catch(_){ window.close(); } };

  }catch(e){
    stopRoll();
    $('num').textContent='â€”';
    setStatus('ç™¼ç”ŸéŒ¯èª¤ï¼š'+(e?.message||e),'err');
    setHint('è«‹è¿”å›ä¸Šä¸€é æˆ–ç¨å¾Œå†è©¦');
    log('fatal', e);
  }
})();
</script>
