<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<pre id="out">啟動中…</pre>
<script>
const LIFF_ID  = '2008311996-D2KEdEnm';
const GAS_EXEC = 'https://script.google.com/macros/s/AKfycbx9GCyBJVC3DmfykG8Jgf9_N_cIp2EMj1Xh5k9UJkPh5N7N67z8rFF8qgtzrQHscNYU/exec';

(async () => {
  try {
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const p = await liff.getProfile();
    document.getElementById('out').textContent = 'OK\n' + JSON.stringify(p, null, 2);

    const payload = { userId: p.userId, displayName: p.displayName, action: 'test', source: 'liff' };

    // 先試 fetch（某些環境可通）
    let sent = false;
    try {
      const res = await fetch(GAS_EXEC, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // 避免 CORS 預檢
        body: JSON.stringify(payload)
      });
      // 只要請求送出就算成功，不必依賴讀取回應
      sent = true;
    } catch (_) {}

    // 若 fetch 失敗，改用 Beacon 圖片（不渲染、不顯示錯誤）
    if (!sent) {
      const u = new URL(GAS_EXEC);
      u.searchParams.set('userId', payload.userId);
      u.searchParams.set('name',   payload.displayName);
      u.searchParams.set('action', payload.action);
      u.searchParams.set('source', payload.source);
      u.searchParams.set('cb', Date.now()); // cache buster
      // 只觸發請求，不加入 DOM、不監聽 onerror（避免「Load failed」字樣）
      (new Image()).src = u.toString();
      sent = true;
    }

    // 給使用者回饋
    if (sent) {
      document.getElementById('out').textContent += '\n已送出記錄 ✅';
    }
  } catch (e) {
    document.getElementById('out').textContent = 'ERR\n' + (e.code || '') + '\n' + (e.message || e);
  }
})();
</script>
