<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIFF 取號</title>
<style>
  :root{--violet:#7c3aed;--indigo:#4f46e5;--bg:#0f0b1f;--card:#1b1633}
  body{margin:0;background:radial-gradient(80% 80% at 50% 0%,#1e1442,#0f0b1f);color:#eef; 
       font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC",Segoe UI,Roboto}
  .wrap{max-width:920px;margin:28px auto;padding:0 16px}
  .card{background:#15122a80;border:1px solid #ffffff14;border-radius:20px;padding:18px;margin:18px 0;
        box-shadow:0 10px 50px #0006}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .kpi{flex:1 1 360px;background:linear-gradient(135deg,#6d28d9,#8b5cf6);border-radius:28px;padding:28px;
       display:flex;justify-content:center;align-items:center;position:relative;box-shadow:0 20px 60px #4b1ab540}
  .kpi:before,.kpi:after{content:"";position:absolute;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;
                         background:#0e0a1f;border:6px solid #00000055}
  .kpi:before{left:-9px}.kpi:after{right:-9px}
  .ticket{font-size:56px;font-weight:800;letter-spacing:2px}
  .muted{color:#aab}
  .ok{color:#22c55e}.err{color:#ef4444}
  pre{background:#0b0a19;border:1px solid #ffffff1a;color:#a7b5ff;padding:12px;border-radius:12px;white-space:pre-wrap;overflow:auto}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:0;
       background:linear-gradient(135deg,var(--violet),var(--indigo));color:#fff;font-weight:700;cursor:pointer}
  .btn-ghost{background:#ffffff10;color:#e8e8ff}
  .badge{font-size:12px;background:#ffffff1a;border:1px solid #ffffff26;color:#ddd;padding:4px 8px;border-radius:999px}
  .tag{display:inline-flex;gap:8px;align-items:center}
</style>

<script>
  /* ==== 你的設定 ==== */
  const LIFF_ID    = '2008311996-D2KEdEnm';
  const GAS_EXEC   = 'https://script.google.com/macros/s/AKfycbzQhqzkAq0V4DqTgh7cSVt-lT1_N0AhRkwutfhZK8yeXPaB2mbG7r6X4g3VQNIzY9r4/exec';
  const MODE       = 'prod';          // 'prod' 自動倒數關閉；'dev' 只顯示倒數不自動關
  const AUTO_CLOSE_SECONDS = 5;       // 倒數秒數
</script>

<div class="wrap">
  <h1 style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <span>LIFF 取號</span>
    <span class="badge">mode: <b id="mode"></b></span>
  </h1>

  <div class="card">
    <div class="row">
      <div class="kpi">
        <div style="text-align:center">
          <div id="ticket" class="ticket">—</div>
          <div id="subtitle" class="muted" style="margin-top:8px">初始化中…</div>
        </div>
      </div>
      <div style="flex:1 1 260px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="tag">狀態：<b id="status" class="muted">啟動中…</b></div>
          <div class="tag">關閉倒數 <b id="cd" style="font-variant-numeric:tabular-nums">—</b></div>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnBack">回到聊天室</button>
          <button class="btn btn-ghost" id="btnReload">重新整理</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <b>開發日誌</b>
    <pre id="log" class="muted"></pre>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  $('mode').textContent = MODE;

  const qs = new URL(location.href).searchParams;
  const actionParam = qs.get('action') || 'default';
  const noClose     = qs.get('noclose') === '1';

  const logLines = [];
  const log = (...args)=>{ 
    const line = args.map(v=> (typeof v==='string'?v:JSON.stringify(v))).join(' ');
    logLines.push(line);
    $('log').textContent = logLines.join('\n');
    console.log(...args);
  };

  let timerId = null;
  let remain = AUTO_CLOSE_SECONDS;

  function startCountdown() {
    // dev 模式或 noclose 時只顯示不關閉
    if (MODE === 'dev' || noClose) {
      $('cd').textContent = `${AUTO_CLOSE_SECONDS}s`;
      return;
    }
    remain = AUTO_CLOSE_SECONDS;
    $('cd').textContent = `${remain}s`;
    clearInterval(timerId);
    timerId = setInterval(()=>{
      remain--;
      $('cd').textContent = `${remain}s`;
      if (remain <= 0) {
        clearInterval(timerId);
        try {
          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            // 外部瀏覽器無法強制關閉 → 導回聊天首頁
            location.href = 'line://nv/chat';
          }
        } catch(e) {
          log('close error', e);
        }
      }
    }, 1000);
  }

  async function sendOnce(payload){
    // 首選：POST（GAS 允許 JSON）
    try{
      log('POST →', JSON.stringify(payload,null,2));
      const r = await fetch(GAS_EXEC, {
        method: 'POST',
        headers: {'Content-Type':'application/json;charset=utf-8'},
        body: JSON.stringify(payload)
      });
      log('POST status', r.status);
      const json = await r.json().catch(()=>null);
      if (json) log('POST json', JSON.stringify(json,null,2));
      return json;
    }catch(e){
      log('POST error', String(e));
      // 備援：GET 像素
      const u = new URL(GAS_EXEC);
      u.searchParams.set('userId', payload.userId);
      u.searchParams.set('name', payload.displayName||'');
      u.searchParams.set('action', payload.action);
      u.searchParams.set('source', payload.source||'liff');
      u.searchParams.set('cb', Date.now());
      const img = new Image();
      img.onerror = ()=> log('BEACON onerror', {isTrusted:true});
      img.src = u.toString();
      return null;
    }
  }

  function showTicket(n, note){
    $('ticket').textContent = n ? `#${n}` : '—';
    $('subtitle').textContent = note || '';
  }

  // 事件按鈕
  $('btnBack').onclick = ()=>{
    remain = 1; // 立即觸發
    startCountdown();
  };
  $('btnReload').onclick = ()=> location.reload();

  (async () => {
    try {
      log(`[${new Date().toLocaleTimeString()}] UA: ${navigator.userAgent}`);
      log(`[${new Date().toLocaleTimeString()}] GAS_EXEC: ${GAS_EXEC}`);
      log(`[${new Date().toLocaleTimeString()}] Location: ${location.href}`);

      $('status').textContent = '初始化 LIFF…';
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      const inClient = liff.isInClient();
      $('status').innerHTML = `<span class="ok">已載入</span>`;
      log(`liff.isInClient=${inClient} os=${liff.getOS()} language=${liff.getLanguage()}`);

      if (!liff.isLoggedIn()) {
        $('status').textContent = '未登入 → 導向登入';
        return liff.login();
      }

      // 取得個資
      const prof = await liff.getProfile();
      log('profile', JSON.stringify(prof,null,2));
      $('status').innerHTML = '已登入 ✅';
      $('subtitle').textContent = '正在抽取您的號碼…';

      // 丟到後端
      const payload = { userId: prof.userId, displayName: prof.displayName, action: actionParam, source: 'liff' };
      const res = await sendOnce(payload);

      // 根據後端回應顯示號碼（若後端有回 ticket）
      let ticket = null, note = '';
      if (res && res.result) {
        ticket = res.result.ticket || null;
        const mode = res.result.mode;
        if (mode === 'already') note = '您今天已取號';
        else if (mode === 'new') note = '取號成功';
        else if (mode === 'renew') note = '已重新領取';
        else if (mode === 'view') note = '目前號碼';
      } else {
        note = '已送出請求，請回聊天室查看';
      }
      showTicket(ticket, note);

      // 啟動倒數（prod 且在 LINE 內才會自動關）
      startCountdown();

    } catch (e) {
      $('status').innerHTML = `<span class="err">發生錯誤：${e?.message||e}</span>`;
      log('ERR', e);
      $('subtitle').textContent = '請返回上一頁或稍後再試';
    }
  })();
})();
</script>
